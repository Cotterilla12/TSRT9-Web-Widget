<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TSRT9</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="top-container">
        <div class="textbox-wrapper">
            <textarea id="mainTextBox" readonly></textarea>
        </div>
    </div>
    
    {% if not singleTaxonomy %}
    <div class="button-container">
        <div class="button-row">
                <button id="InstructionsBtn" onclick="showInstructions()">Instructions</button>
                <button id="ClBtn" onclick="showSingleScreenOptions('Cl')">Classification</button>
                <button id="PPSBtn" onclick="showMultiScreenOptions('PPS')">Primary Pathway Subcode</button>
                <button id="APSBtn" onclick="showMultiScreenOptions('APS')">Additional Pathway Subcode</button>
                <button id="MDBtn" onclick="showMultiScreenOptions('MD')">Method of Detection</button>
                <button id="CFBtn" onclick="showMultiScreenOptions('CF')">Contributory Factors</button>
                <button id="ModalityBtn" onclick="showSingleScreenOptions('Modality')">Modality</button>
                <button id="SupplementalBtn" onclick="showSupplementalOptions()">Supplemental Info</button>
        </div>
    </div>
    {% endif %}

    <!-- Dynamic menus for taxonomy entries -->
    <div class="taxonomy-container">
        <div id="taxonomyMenuSingle" style="display:none"></div>
        <div id="taxonomyMenu" style="display:none">
            <div class="menu-container">
                <div class="left-bar" id="leftContent"></div>
                <div class="right-content" id="rightContent"></div>
            </div>
        </div>
    </div>

    <div class="clear-button-wrapper">
        <button id="ClearBtn" onclick="clearText()">Reset</button>
    </div>    

    <script>
        // Placeholder strings
        const CL_PLACEHOLDER = "Classification";
        const PS_PLACEHOLDER = "Pathway Subcode(s)";
        const MD_PLACEHOLDER = "Method of Detection";
        const CF_PLACEHOLDER = "Contributory Factor(s)";
        const MODALITY_PLACEHOLDER = "Modality";

        // Taxonomy Variables
        let Displayed_Cl = "";
        let Displayed_PPS = "";
        let Displayed_APS = [];
        let Displayed_MD = "";
        let Displayed_CF = [];
        let Displayed_Modality = "";

        // Supplemental information dict
        let SupplementalInfo_Dict = {
            anatomicalSite: "",
            prescribedDose: 0,
            fractionation: 0,
            intendedExposure: 0,
            actualExposure: 0,
            geographicMisplacement: 0,
            CFdescription: {},
            detection: "",
            precedingDetectionPoints: [],
            patientImplications: "",
            correctiveActions: "",
            equipmentRelatedInformation: {}
        };

        function UpdateTextbox() {
            const tb = document.getElementById("mainTextBox");

            {% if singleTaxonomy %}
                const taxonomy = "{{ singleTaxonomy }}"

                if (taxonomy == "Cl") {
                    tb.value = Displayed_Cl.length ? Displayed_Cl : CL_PLACEHOLDER;
                } else if (taxonomy == "PPS") {
                    tb.value = Displayed_PPS.length ? Displayed_PPS : "Pathway Subcode";
                } else if (taxonomy == "APS") {
                    tb.value = Displayed_APS.length ? Displayed_APS.join(" / ") : PS_PLACEHOLDER;
                } else if (taxonomy == "MD") {
                    tb.value = Displayed_MD.length ? Displayed_MD : MD_PLACEHOLDER;
                } else if (taxonomy == "CF") {
                    tb.value = Displayed_CF.length ? Displayed_CF.join(" / ") : CF_PLACEHOLDER;
                } else if (taxonomy == "Modaliity") {
                    tb.value = Displayed_Modality.length ? Displayed_Modality : MODALITY_PLACEHOLDER;
                }
            {% else %}
                let finalText = "TSRT9";

                let Cl = Displayed_Cl.length ? Displayed_Cl : CL_PLACEHOLDER;
                let PPS = Displayed_PPS.length ? Displayed_PPS : PS_PLACEHOLDER;
                let APS = Displayed_APS.length ? Displayed_APS.join(" / ") : "";
                let MD = Displayed_MD.length ? Displayed_MD : MD_PLACEHOLDER;
                let CF = Displayed_CF.length ? Displayed_CF.join(" / ") : CF_PLACEHOLDER;
                let Modality = Displayed_Modality.length ? Displayed_Modality : MODALITY_PLACEHOLDER;

                if (APS.length == 0) {
                    tb.value = ["TSRT9"].concat([Cl], [PPS], [MD], [CF], [Modality]).join(" / ");
                } else {
                    tb.value = ["TSRT9"].concat([Cl], [PPS], [APS], [MD], [CF], [Modality]).join(" / ");
                }
            {% endif %}
        }
        
        function showInstructions() {
            document.getElementById("taxonomyMenu").style.display = 'none';
            const menu = document.getElementById("taxonomyMenuSingle");
            menu.innerHTML = `<h3>Instructions:</h3>
            <p>1. Start by clicking the "Severity Level" button to select the appropriate severity (only one is able to be selected)<br>
                2. Continue to the "Pathway Codes" section and select all options that apply<br>
                3. Proceed to the "Method of Detection" and make the appropriate selection (only one is able to be selected)<br>
                4. Next, open the "Causative Factors" section and tick all applicable factors<br>
                5. Once all sections are complete, the assembled incident code will appear in the box above<br>
                6. To begin again, click the "Reset" button to reset all selections and start fresh</p>`;
            menu.style.display = 'block';
            if ("{{ singleTaxonomy|default('') }}".trim() === "") {
                toggleMenuButtons("InstructionsBtn");
            };
        }

        function displayInstructions(instructions){
            const menu = document.getElementById("rightContent");
            menu.innerHTML = instructions;
        }

        function singleTaxonomyInstructions(instructions){
            {% if singleTaxonomy %}
                const menu = document.getElementById("leftContent");
                const wrapper = document.createElement("div");
                wrapper.className = "taxonomy-entry";

                const button = document.createElement("button");
                button.textContent = "Instructions";
                button.classList.add("toggle-button");
                button.id = "instructionsBtn";
                button.onclick = () => {
                    displayInstructions(instructions);
                    toggleButtons(button.id, "leftContent");
                }

                wrapper.appendChild(button);
                menu.appendChild(wrapper);

                button.click();
            {% endif %}
        }

        function showSingleScreenOptions(taxonomy) {
            document.getElementById("taxonomyMenu").style.display = 'none';
            const menu = document.getElementById("taxonomyMenuSingle");
            menu.innerHTML = 'Loading Classifications';
            menu.style.display = 'block';
            if ("{{ singleTaxonomy|default('') }}".trim() === "") {
                toggleMenuButtons(taxonomy + "Btn");
            };

            let api = "";
            if (taxonomy == "Cl"){
                api = "classification"
            } else if (taxonomy == "Modality"){
                api = "modality"
            }

            fetch(`/api/${api}`)
                .then(res => res.json())
                .then(data => {
                    menu.innerHTML = '';

                    // Placing instructions if this is loaded in single taxonomy
                    {% if singleTaxonomy %}
                        const wrapper = document.createElement("div");
                        wrapper.className = "taxonomy-entry";

                        const label = document.createElement("label");
                        label.textContent = `Please select the appropriate ${api} (only one is able to be selected)`;
                        wrapper.appendChild(label);
                        menu.appendChild(wrapper);
                    {% endif %}

                    Object.entries(data).forEach(([code, description]) => {
                        const wrapper = document.createElement("div");
                        wrapper.className = "taxonomy-entry";

                        const button = document.createElement("button");
                        button.textContent = code;
                        button.id = "btn" + code.split(" ").join("");
                        button.classList.add("toggle-button");
                        button.onclick = () => {
                            insertRemoveCode(code, taxonomy);
                            toggleButtons(button.id, "taxonomyMenuSingle");
                        }

                        const desc = document.createElement("div");
                        desc.className = "description";
                        desc.innerHTML = `<strong>${description}</strong>`;

                        wrapper.appendChild(button);
                        wrapper.appendChild(desc);
                        menu.appendChild(wrapper);

                        if (document.getElementById("mainTextBox").value.includes(code)){
                            toggleButtons(button.id, "taxonomyMenuSingle")
                        }
                    });
                })
                .catch(err => {
                    menu.innerHTML = `<p style="color:red;">Failed to load ${api}.</p>`;
                    console.error(err);
                });
        }

        function showSupplementalOptions() {
            document.getElementById("taxonomyMenu").style.display = 'none';
            const menu = document.getElementById("taxonomyMenuSingle");
            menu.innerHTML = 'Loading Supplemental Information';
            menu.style.display = 'block';
            if ("{{ singleTaxonomy|default('') }}".trim() === "") {
                toggleMenuButtons("SupplementalBtn");
            };

            // Loading data for anatomical sites and then loading all other information
            fetch("/api/sites")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json(); // Assumes response is JSON
                })
                .then(sites => {
                    menu.innerHTML = '<h1 style="color: red">Coming Soon, not completed</h1><br>';

                    // Adding in all of the data fields
                    const anatomicalSiteLbl = createLabel("Anatomical Site: ")
                    const anatomicalSiteDD = createDropdown("anatomicalSite", sites);
                    createWrapper([anatomicalSiteLbl, anatomicalSiteDD], menu);
                    
                    const prescribedDoseLbl = createLabel("Prescribed Dose: ")
                    const prescribedDoseNI = createNumberInput("prescribedDose");
                    const GyLbl1 = createLabel("Gy");
                    createWrapper([prescribedDoseLbl, prescribedDoseNI, GyLbl1], menu);
                    
                    const fractionationLbl = createLabel("Fractionation: ")
                    const fractionationNI = createNumberInput("fractionation");
                    const hash = createLabel("#");
                    createWrapper([fractionationLbl, fractionationNI, hash], menu);
                    
                    const intendedExposureLbl = createLabel("Intended Exposure: ")
                    const intendedExposureNI = createNumberInput("intendedExposure");
                    const GyLbl2 = createLabel("Gy");
                    createWrapper([intendedExposureLbl, intendedExposureNI, GyLbl2], menu);
                    
                    const actualExposureLbl = createLabel("Actual Exposure: ")
                    const actualExposureNI = createNumberInput("actualExposure");
                    const GyLbl3 = createLabel("Gy");
                    createWrapper([actualExposureLbl, actualExposureNI, GyLbl3], menu);
                    
                    const geographicMisplacementLbl = createLabel("Geographic Misplacement: ")
                    const geographicMisplacementNI = createNumberInput("geographicMisplacement");
                    const mm = createLabel("mm");
                    createWrapper([geographicMisplacementLbl, geographicMisplacementNI, mm], menu);

                    menu.innerHTML += "<br>";

                    const cfDescWrapper = createWrapper([createLabel("Description of each contributory Factor:")], menu);
                    if (Displayed_CF.length == 0) {
                        const lbl = createLabel("No contributory factors have been selected");
                        lbl.style.color = "red";
                        createWrapper([lbl], menu);
                    }
                    Displayed_CF.forEach(cf => {
                        const cfLbl = createLabel(cf + ": ")
                        const cfTI = createTextInput(cf + "Desc");

                        const spacer = document.createElement("div");
                        spacer.style.width = "30px";
                        spacer.style.display = "inline-block";
                        spacer.style.visibility = "hidden";

                        createWrapper([spacer, cfLbl, cfTI], menu);
                    });

                    menu.innerHTML += "<br>";

                    const detectionLblWrapper = createWrapper([createLabel("Describe how the issue was detected: ")], menu);
                    const detectionTB = createTextarea("detection");
                    detectionTB.style.width = "90%";
                    const detectionTBWrapper = createWrapper([detectionTB], menu);

                    menu.innerHTML += "<br>";

                    createWrapper([createLabel("Select all areas of the pathway where this issue should have been detected:")], menu);
                    var iframe = document.createElement('iframe');
                    iframe.src = "/widget/APS"
                    iframe.style.width = "95%";
                    iframe.style.height = "300px";
                    const iframeWrapper = document.createElement("div");
                    iframeWrapper.style.textAlign = "center";
                    iframeWrapper.appendChild(iframe);
                    menu.appendChild(iframeWrapper);

                    menu.innerHTML += "<br>";

                    const patientImplicationsLblWrapper = createWrapper([createLabel("Describe the implications experienced by the patient due to this error: ")], menu);
                    const patientImplicationsTB = createTextarea("patientImplications");
                    patientImplicationsTB.style.width = "90%";
                    const patientImplicationsTBWrapper = createWrapper([patientImplicationsTB], menu);

                    menu.innerHTML += "<br>";

                    const correctiveActionsLblWrapper = createWrapper([createLabel("Describe the corrective actions needing to take place: ")], menu);
                    const correctiveActionsTB = createTextarea("correctiveActions");
                    correctiveActionsTB.style.width = "90%";
                    const correctiveActionsTBWrapper = createWrapper([correctiveActionsTB], menu);

                    menu.innerHTML += "<br>";
                    
                    createWrapper([createLabel("Equipment related Malfunctions:")], menu);
                    Object.keys(SupplementalInfo_Dict.equipmentRelatedInformation).forEach(key => {
                        const spacer1 = document.createElement("div");
                        spacer1.style.width = "30px";
                        spacer1.style.display = "inline-block";
                        spacer1.style.visibility = "hidden";

                        const serialNumberLbl = createLabel("Serial No: ");
                        const serialNumberTI = createTextInput(key + "SerialNo");
                        serialNumberTI.style.width = "60px";
                        
                        const spacer2 = document.createElement("div");
                        spacer2.style.width = "30px";
                        spacer2.style.display = "inline-block";
                        spacer2.style.visibility = "hidden";

                        const equipmentTypeLbl = createLabel("Equipment Type: ");
                        const equipmentTypeTI = createTextInput(key + "EquipmentType");
                        equipmentTypeTI.style.width = "75px";

                        const spacer3 = document.createElement("div");
                        spacer3.style.width = "30px";
                        spacer3.style.display = "inline-block";
                        spacer3.style.visibility = "hidden";

                        const malfunctionLbl = createLabel("Malfunction: ");
                        const malfunctionTI = createTextInput(key + "Malfunction");
                        malfunctionTI.style.width = "75px";

                        createWrapper([spacer1, serialNumberLbl, serialNumberTI, spacer2, equipmentTypeLbl, equipmentTypeTI, spacer3, malfunctionLbl, malfunctionTI], menu);
                    });
                    const spacer1 = document.createElement("div");
                        spacer1.style.width = "30px";
                        spacer1.style.display = "inline-block";
                        spacer1.style.visibility = "hidden";

                        const serialNumberLbl = createLabel("Serial No: ");
                        const serialNumberTI = createTextInput("newSerialNo");
                        serialNumberTI.style.width = "20%";
                        
                        const spacer2 = document.createElement("div");
                        spacer2.style.width = "30px";
                        spacer2.style.display = "inline-block";
                        spacer2.style.visibility = "hidden";

                        const equipmentTypeLbl = createLabel("Equipment Type: ");
                        const equipmentTypeTI = createTextInput("newEquipmentType");
                        equipmentTypeTI.style.width = "20%";

                        const spacer3 = document.createElement("div");
                        spacer3.style.width = "30px";
                        spacer3.style.display = "inline-block";
                        spacer3.style.visibility = "hidden";

                        const malfunctionLbl = createLabel("Malfunction: ");
                        const malfunctionTI = createTextInput("newMalfunction");
                        malfunctionTI.style.width = "50%";

                        createWrapper([spacer1, serialNumberLbl, serialNumberTI, spacer2, equipmentTypeLbl, equipmentTypeTI], menu);
                        createWrapper([spacer3, malfunctionLbl, malfunctionTI], menu);
                })
        }

        function createWrapper(objects, body) {
            const wrapper = document.createElement("div");
            wrapper.style.width = "95%";
            wrapper.style.margin = "5px 15px";
            wrapper.style.display = "flex";
            wrapper.style.flexDirection = "row";
            wrapper.style.alignItems = "in"; // align left
            wrapper.style.gap = "5px"; // optional spacing between items

            objects.forEach(obj => {
                wrapper.appendChild(obj);
            });

            body.appendChild(wrapper);
            return wrapper;
        }

        function createLabel(text) {
            const label = document.createElement("label");
            label.textContent = text;

            return label;
        }

        function createDropdown(key, options) {
            const select = document.createElement("select");
            select.id = key;
            select.style.fontSize = "18px";

            const unselectOption = document.createElement("option");
            unselectOption.value = "";
            unselectOption.textContent = "";
            select.appendChild(unselectOption);

            options.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });

            select.onchange = function () {
                SupplementalInfo_Dict[key] = select.value;
                console.log(SupplementalInfo_Dict);
            };

            return select;
        }

        function createNumberInput(key, max = 100, value = 0) {
            const input = document.createElement("input");
            input.type = "number";
            input.id = key;
            input.style.fontSize = "18px";
            input.min = 0;
            input.value = value;
            input.style.width = "60px";

            input.onchange = function () {
                SupplementalInfo_Dict[key] = input.value;
                console.log(SupplementalInfo_Dict);
            };

            return input;
        }

        function createTextInput(id, text = "") {
            const input = document.createElement("input");
            input.type = "text";
            input.id = id;
            input.style.fontSize = "18px";
            input.textContent = text;
            input.style.width = "50%";

            return input;
        }

        function createTextarea(key, text = "", rows = 2, cols = 50) {
            const textarea = document.createElement("textarea");
            textarea.id = key;
            textarea.style.fontSize = "18px";
            textarea.rows = rows;
            textarea.cols = cols;
            textarea.textContent = text;

            textarea.onchange = function () {
                SupplementalInfo_Dict[key] = textarea.textContent;
            };

            return textarea;
        }

        function copyToClipboard(){
            const tbString = document.getElementById("mainTextBox").value;
            navigator.clipboard.writeText(tbString);
        }

        function toggleButtons(btnID, parentID) {
            const btnOfInterest = document.getElementById(btnID);
            const parent = document.getElementById(parentID);

            const buttons = parent.querySelectorAll(".toggle-button");

            buttons.forEach(button => {
                button.classList.remove("selected-button");
            });

            if (btnOfInterest){
                btnOfInterest.classList.add("selected-button");
            }
        }

        function insertRemoveCode(code, taxonomy, addBool = true) {
            const tb = document.getElementById("mainTextBox");
            let tbList = tb.value.split(" / ");

            if (taxonomy == "Cl") {
                Displayed_Cl = code;
            } else if (taxonomy == "PPS") {
                Displayed_PPS = code;

                if (Displayed_APS.includes(Displayed_PPS)) {
                    const index = Displayed_APS.indexOf(code);

                    if (index != -1) {
                        Displayed_APS.splice(index, 1);
                    }
                }
            } else if (taxonomy == "APS") {
                if (addBool) {
                    Displayed_APS = sortCodes([...new Set(Displayed_APS.concat(code))]);
                } else {
                    const index = Displayed_APS.indexOf(code);

                    if (index != -1) {
                        Displayed_APS.splice(index, 1);
                    }
                }
            } else if (taxonomy == "MD") {
                Displayed_MD = code;
            } else if (taxonomy == "CF") {
                if (addBool) {
                    Displayed_CF = sortCodes([...new Set(Displayed_CF.concat(code))]);
                } else {
                    const index = Displayed_CF.indexOf(code);

                    if (index != -1) {
                        Displayed_CF.splice(index, 1);
                    }
                }
            } else if (taxonomy == "Modality") {
                Displayed_Modality = code;
            }

            UpdateTextbox();
            updateMenuButtonStatus();

            // Inform the parent window the taxonomies have been updated
            window.parent.postMessage({ action: "taxonomyUpdated" }, "*");
        }

        function showMultiScreenOptions(taxonomy) {
            document.getElementById("taxonomyMenuSingle").style.display = 'none';
            document.getElementById("leftContent").innerHTML = '';
            document.getElementById("rightContent").innerHTML = '';
            const menu = document.getElementById("leftContent");

            let api = "";
            let displayPlaceholder = "";

            if (taxonomy == "PPS"){
                api = "pathwaysubcodes"
                displayPlaceholder = "Pathway Subcodes"
            } else if (taxonomy == "APS"){
                api = "pathwaysubcodes"
                displayPlaceholder = "Pathway Subcodes"
            } else if (taxonomy == "MD"){
                api = "pathwaysubcodes"
                displayPlaceholder = "Pathway Subcodes"
            } else if (taxonomy == "CF"){
                api = "contributoryfactors"
                displayPlaceholder = "Contributory Factors"
            }

            menu.innerHTML = `Loading ${api} Categories`;
            document.getElementById("taxonomyMenu").style.display = 'flex';
            toggleMenuButtons(taxonomy + "Btn");

            fetch(`/api/${api}`)
                .then(res => res.json())
                .then(data => {
                    menu.innerHTML = '';

                    // Placing instructions if this is loaded in single taxonomy
                    instructions = `Please carefully look through each record and select one or more ${displayPlaceholder.toLowerCase()} that best describe the process or pathway involved. You're welcome to choose multiple codes if they clearly apply. Refer to the official definitions if you need assistance.<br><br>Press the reset button at the bottom to reset the codes selected.`
                    singleTaxonomyInstructions(instructions);

                    Object.entries(data).forEach((category) => {
                        const wrapper = document.createElement("div");
                        wrapper.className = "taxonomy-entry";

                        const button = document.createElement("button");
                        button.textContent = category[1];
                        button.classList.add("toggle-button");
                        button.id = "btn" + category[1].split(":")[0];
                        button.onclick = () => {
                            displayCategory(category[1], taxonomy);
                            toggleButtons(button.id, "leftContent");
                        }

                        wrapper.appendChild(button);
                        menu.appendChild(wrapper);
                    });
                })
                .catch(err => {
                    menu.innerHTML = `<p style="color:red;">Failed to load ${displayPlaceholder.toLowerCase()}.</p>`;
                    console.error(err);
                });
        }

        function displayCategory(category, taxonomy){
            let api = "";
            let single = false;
            let displayPlaceholder = "";

            if (taxonomy == "PPS"){
                api = "pathwaysubcodes"
                single = true;
                displayPlaceholder = "Pathway Subcodes"
            } else if (taxonomy == "APS"){
                api = "pathwaysubcodes"
                displayPlaceholder = "Pathway Subcodes"
            } else if (taxonomy == "MD"){
                api = "pathwaysubcodes"
                single = true;
                displayPlaceholder = "Pathway Subcodes"
            } else if (taxonomy == "CF"){
                api = "contributoryfactors"
                displayPlaceholder = "Contributory Factors"
            }

            const menu = document.getElementById("rightContent");
            menu.innerHTML = `Loading ${displayPlaceholder}`;

            fetch(`/api/${api}/${category}`)
                .then(res => res.json())
                .then(data => {
                    menu.innerHTML = '';
                    sortCodes(Object.keys(data)).forEach(code => {
                        const detailList = data[code];
                        const label = detailList;

                        const wrapper = document.createElement("div");
                        wrapper.className = "taxonomy-entry";

                        if (single){
                            const detailList = data[code];
                            const label = detailList;

                            const wrapper = document.createElement("div");
                            wrapper.className = "taxonomy-entry";

                            const button = document.createElement("button");
                            button.textContent = code
                            button.classList.add("toggle-button");
                            button.id = "btn" + code;
                            button.onclick = () => {
                                insertRemoveCode(taxonomy == "MD" ? "MD" + code : code, taxonomy);
                                toggleButtons(button.id, "rightContent");
                            }

                            const buttonLabel = document.createElement("label");
                            buttonLabel.innerHTML = label;

                            wrapper.appendChild(button);
                            wrapper.appendChild(buttonLabel);
                            menu.appendChild(wrapper);

                            if (document.getElementById("mainTextBox").value.includes(taxonomy == "MD" ? "MD" + code : code) && taxonomy != "PPS"){
                                toggleButtons(button.id, "rightContent")
                            } else if (taxonomy == "PPS" && document.getElementById("mainTextBox").value.split(" / ")[2] == code){
                                toggleButtons(button.id, "rightContent")
                            }
                        } else{
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.value = label;
                            checkbox.id = `cb-${code}`;
                            checkbox.checked = document.getElementById("mainTextBox").value.split(" / ").splice(4).includes(code);

                            {% if not singleTaxonomy %}
                                checkbox.disabled = document.getElementById("mainTextBox").value.split("/")[2].trim() == code
                            {% endif %}

                            if ("{{ singleTaxonomy|default('') }}".trim() != ""){
                                checkbox.checked = document.getElementById("mainTextBox").value.includes(code);
                            }
                            checkbox.onchange = () => insertRemoveCode(code, taxonomy, checkbox.checked);

                            const checkboxLabel = document.createElement("label");
                            checkboxLabel.htmlFor = checkbox.id;
                            checkboxLabel.innerHTML = `${code}: ${label}`;

                            wrapper.appendChild(checkbox);
                            wrapper.appendChild(checkboxLabel);
                            menu.appendChild(wrapper);
                        }
                    });
                })
                .catch(err => {
                    menu.innerHTML = '<p style="color:red;">Failed to load pathway subcodes.</p>';
                    console.error(err);
                }
            );
        }

        function isNumeric(n) {
            return !isNaN(parseFloat(n)) && isFinite(n);
        }

        function toggleMenuButtons(activeBtnID) {
            const buttons = document.querySelectorAll(".button-row button");

            buttons.forEach(btn => {
                btn.classList.remove("selected-button");
            });

            const activeBtn = document.getElementById(activeBtnID);
            if (activeBtn) {
                activeBtn.classList.add("selected-button");
            }
        }

        function sortCodes(codes){
            if (codes.length == 0){
                return [];
            }

            const example = codes[0];

            let prefix = "";
            for (i = 0; i < example.length; i++){
                if(isNumeric(example[i])){
                    prefix = example.slice(0, i);
                    break;
                }
            }

            let splitCodes = [];

            for (j = 0; j < codes.length; j++){
                let index = -1;

                for (k = prefix.length; k < codes[j].length; k++){
                    if(!isNumeric(codes[j][k])){
                        index = k;
                        break;
                    }
                }

                splitCodes.push([prefix, codes[j].slice(prefix.length, index), codes[j].slice(index)]);
            }

            splitCodes.sort((a, b) => {
                const numA = parseInt(a[1], 10);
                const numB = parseInt(b[1], 10);
                if (numA !== numB) return numA - numB;
                if (a[2].length !== b[2].length) return a[2].length - b[2].length;
                return a[2].localeCompare(b[2]);
            });

            return splitCodes.map(parts => prefix + parts[1] + parts[2]);
        }

        function updateMenuButtonStatus() {
            {% if not singleTaxonomy %}
                const tbString = document.getElementById("mainTextBox").value;

                const sections = {
                    Cl: [CL_PLACEHOLDER, "ClBtn"],
                    PPS: [PS_PLACEHOLDER, "PPSBtn"],
                    APS: [PS_PLACEHOLDER, "APSBtn"],
                    MD: [MD_PLACEHOLDER, "MDBtn"],
                    CF: [CF_PLACEHOLDER, "CFBtn"],
                    Modality: [MODALITY_PLACEHOLDER, "ModalityBtn"]
                };

                if (tbString.split(" / ")[2] == PS_PLACEHOLDER){
                    document.getElementById("APSBtn").disabled == true;
                } else{
                    document.getElementById("APSBtn").disabled == false;
                }

                Object.entries(sections).forEach(([taxonomy, [placeholder, btnID]]) => {
                    const btn = document.getElementById(btnID);
                    // Only try to update the button if it actually exists
                    if (!btn) return;

                    if (!tbString.includes(placeholder)) {
                        btn.classList.add("menu-button-complete");
                    } else {
                        btn.classList.remove("menu-button-complete");
                    }
                });

                const InstructionsBtn = document.getElementById("InstructionsBtn");
                InstructionsBtn.classList.add("menu-button-complete");
            {% endif %}
        }

        function clearText() {
            let taxonomy = "{{ singleTaxonomy|default('') }}".toUpperCase();
            document.getElementById("rightContent").innerHTML = "";
            toggleButtons("", "leftContent");
            toggleButtons("", "taxonomyMenuSingle");
            
            Displayed_Cl = sortCodes({{ ClTaxonomy|default("")|tojson }});
            Displayed_PPS = sortCodes({{ PPSTaxonomy|default("")|tojson }});
            Displayed_APS = sortCodes({{ APSTaxonomy|default([])|tojson }});
            Displayed_MD = sortCodes({{ MDTaxonomy|default("")|tojson }});
            Displayed_CF = sortCodes({{ CFTaxonomy|default([])|tojson }});
            Displayed_Modality = sortCodes({{ modalityTaxonomy|default("")|tojson }});

            SupplementalInfo_Dict = {
                anatomicalSite: "",
                prescribedDose: -1,
                fractionation: -1,
                intendedExposure: -1,
                intendedExposure: -1,
                geographicMisplacement: -1,
                CFdescription: {},
                detection: "",
                precedingDetectionPoints: [],
                patientImplications: "",
                correctiveActions: "",
                equipmentRelatedInformation: {}
            };
            
            UpdateTextbox();
            updateMenuButtonStatus();
        }

        window.addEventListener("message", function(event) {
            // Optionally, validate event.origin here.
            if (event.data && event.data.action === "getValue") {
                const value = document.getElementById("mainTextBox").value;
                window.parent.postMessage({ action: "sendValue", value: value }, "*");
            }
        });

        window.addEventListener("DOMContentLoaded", function() {
            // Directly call clearText to set the correct taxonomies
            clearText();
            toggleMenuButtons("");

            var singleTax = "{{ singleTaxonomy|default('') }}".toUpperCase();
            if (singleTax) {
                if (["CL", "MODALITY"].includes(singleTax)){
                    showSingleScreenOptions(singleTax.charAt(0).toUpperCase() + singleTax.slice(1).toLowerCase())
                } else if (["PPS", "APS", "MD", "CF"].includes(singleTax)){
                    showMultiScreenOptions(singleTax);
                }
            }
            else {
                showInstructions();
                const InstructionsBtn = document.getElementById("InstructionsBtn");
                InstructionsBtn.classList.remove("menu-button-complete");
            }
        });
    </script>
</body>
</html>
