<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TSRT9</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="top-container">
        <div class="textbox-wrapper">
            <textarea id="mainTextBox" readonly></textarea>
        </div>
    </div>
    
    {% if not singleTaxonomy %}
    <div class="button-container">
        <div class="button-row">
                <button id="InstructionsBtn" onclick="showInstructions()">Instructions</button>
                <button id="ClBtn" onclick="showSingleScreenOptions('Cl')">Classification</button>
                <button id="PPSBtn" onclick="showMultiScreenOptions('PPS')">Primary Pathway Subcode</button>
                <button id="APSBtn" onclick="showMultiScreenOptions('APS')">Additional Pathway Subcode</button>
                <button id="MDBtn" onclick="showMultiScreenOptions('MD')">Method of Detection</button>
                <button id="CFBtn" onclick="showMultiScreenOptions('CF')">Contributory Factors</button>
                <button id="ModalityBtn" onclick="showSingleScreenOptions('Modality')">Modality</button>
                <button id="SupplementalBtn" onclick="showSupplementalOptions()">Supplemental Info</button>
        </div>
    </div>
    {% endif %}
    

    <!-- Dynamic menus for taxonomy entries -->
    <div class="taxonomy-container">
        <div id="taxonomyMenuSingle" style="display:none"></div>
        <div id="taxonomyMenu" style="display:none">
            <div class="menu-container">
                <div class="left-bar" id="leftContent"></div>
                <div class="right-content" id="rightContent"></div>
            </div>
        </div>
    </div>

    <div class="clear-button-wrapper">
        <button id="ClearBtn" onclick="clearText()">Reset</button>
    </div>    

    <script>
        function showInstructions() {
            document.getElementById("taxonomyMenu").style.display = 'none';
            const menu = document.getElementById("taxonomyMenuSingle");
            menu.innerHTML = `<h3>Instructions:</h3>
            <p>1. Start by clicking the "Severity Level" button to select the appropriate severity (only one is able to be selected)<br>
                2. Continue to the "Pathway Codes" section and select all options that apply<br>
                3. Proceed to the "Method of Detection" and make the appropriate selection (only one is able to be selected)<br>
                4. Next, open the "Causative Factors" section and tick all applicable factors<br>
                5. Once all sections are complete, the assembled incident code will appear in the box above<br>
                6. To begin again, click the "Reset" button to reset all selections and start fresh</p>`;
            menu.style.display = 'block';
            if ("{{ singleTaxonomy|default('') }}".trim() === "") {
                toggleMenuButtons("InstructionsBtn");
            };
        }

        function displayInstructions(instructions){
            const menu = document.getElementById("rightContent");
            menu.innerHTML = instructions;
        }

        function singleTaxonomyInstructions(instructions){
            {% if singleTaxonomy %}
                const menu = document.getElementById("leftContent");
                const wrapper = document.createElement("div");
                wrapper.className = "taxonomy-entry";

                const button = document.createElement("button");
                button.textContent = "Instructions";
                button.classList.add("toggle-button");
                button.id = "instructionsBtn";
                button.onclick = () => {
                    displayInstructions(instructions);
                    toggleButtons(button.id, "leftContent");
                }

                wrapper.appendChild(button);
                menu.appendChild(wrapper);

                button.click();
            {% endif %}
        }

        function showSingleScreenOptions(taxonomy) {
            document.getElementById("taxonomyMenu").style.display = 'none';
            const menu = document.getElementById("taxonomyMenuSingle");
            menu.innerHTML = 'Loading Classifications';
            menu.style.display = 'block';
            if ("{{ singleTaxonomy|default('') }}".trim() === "") {
                toggleMenuButtons(taxonomy + "Btn");
            };

            let api = "";
            if (taxonomy == "Cl"){
                api = "classification"
            } else if (taxonomy == "Modality"){
                api = "modality"
            }
            

            fetch(`/api/${api}`)
                .then(res => res.json())
                .then(data => {
                    menu.innerHTML = '';

                    // Placing instructions if this is loaded in single taxonomy
                    {% if singleTaxonomy %}
                        const wrapper = document.createElement("div");
                        wrapper.className = "taxonomy-entry";

                        const label = document.createElement("label");
                        label.textContent = `Please select the appropriate ${api} (only one is able to be selected)`;
                        wrapper.appendChild(label);
                        menu.appendChild(wrapper);
                    {% endif %}

                    Object.entries(data).forEach(([code, description]) => {
                        const wrapper = document.createElement("div");
                        wrapper.className = "taxonomy-entry";

                        const button = document.createElement("button");
                        button.textContent = code;
                        button.id = "btn" + code.split(" ").join("");
                        button.classList.add("toggle-button");
                        button.onclick = () => {
                            insertSingleCode(code, taxonomy);
                            toggleButtons(button.id, "taxonomyMenuSingle");
                        }

                        const desc = document.createElement("div");
                        desc.className = "description";
                        desc.innerHTML = `<strong>${description}</strong>`;

                        wrapper.appendChild(button);
                        wrapper.appendChild(desc);
                        menu.appendChild(wrapper);

                        if (document.getElementById("mainTextBox").value.includes(code)){
                            toggleButtons(button.id, "taxonomyMenuSingle")
                        }
                    });
                })
                .catch(err => {
                    menu.innerHTML = `<p style="color:red;">Failed to load ${api}.</p>`;
                    console.error(err);
                });
        }

        function copyToClipboard(){
            const tbString = document.getElementById("mainTextBox").value;
            navigator.clipboard.writeText(tbString);
        }

        function toggleButtons(btnID, parentID) {
            const btnOfInterest = document.getElementById(btnID);
            const parent = document.getElementById(parentID);

            const buttons = parent.querySelectorAll(".toggle-button");

            buttons.forEach(button => {
                button.classList.remove("selected-button");
            });

            if (btnOfInterest){
                btnOfInterest.classList.add("selected-button");
            }
        }

        function insertSingleCode(code, taxonomy) {
            const tb = document.getElementById("mainTextBox");
            let tbList = tb.value.split(" / ");

            {% if singleTaxonomy %}
                tb.value = code;
            {% else %}
                let MDPoint = -1;
                for (let i = 4; i < tbList.length; i++){
                    if (tbList[i].includes("MD") || tbList[i].includes("(Method of Detection)")){
                        MDPoint = i;
                        break;
                    }
                }

                let ClTax = tbList.slice(0, 2);
                let PPSTax = tbList.slice(2, 3);
                let APSTax = tbList.slice(3, MDPoint);
                let MDTax = tbList[MDPoint];
                let CFTax = tbList.slice(MDPoint + 1, tbList.length - 1);
                let modalityTax = tbList[tbList.length - 1];

                let placeholder = "";
                if (taxonomy == "Cl"){
                    tbList[1] = code;
                } else if (taxonomy == "PPS"){
                    tbList[2] = code;
                } else if (taxonomy == "MD"){
                    tbList[MDPoint] = code;
                } else if (taxonomy == "Modality"){
                    tbList[tbList.length - 1] = code;
                }

                tb.value = tbList.join(" / ");
            {% endif %}

            updateMenuButtonStatus();

            // Inform the parent window the taxonomies have been updated
            window.parent.postMessage({ action: "taxonomyUpdated" }, "*");
        }

        function showMultiScreenOptions(taxonomy) {
            document.getElementById("taxonomyMenuSingle").style.display = 'none';
            document.getElementById("leftContent").innerHTML = '';
            document.getElementById("rightContent").innerHTML = '';
            const menu = document.getElementById("leftContent");

            let api = "";
            let placeholder = "";

            if (taxonomy == "PPS"){
                api = "pathwaysubcodes"
                placeholder = "Pathway Subcodes"
            } else if (taxonomy == "APS"){
                api = "pathwaysubcodes"
                placeholder = "Pathway Subcodes"
            } else if (taxonomy == "MD"){
                api = "pathwaysubcodes"
                placeholder = "Pathway Subcodes"
            } else if (taxonomy == "CF"){
                api = "contributoryfactors"
                placeholder = "Contributory Factors"
            }

            menu.innerHTML = `Loading ${api} Categories`;
            document.getElementById("taxonomyMenu").style.display = 'flex';
            toggleMenuButtons(taxonomy + "Btn");

            fetch(`/api/${api}`)
                .then(res => res.json())
                .then(data => {
                    menu.innerHTML = '';

                    // Placing instructions if this is loaded in single taxonomy
                    instructions = `Please carefully look through each record and select one or more ${placeholder.toLowerCase()} that best describe the process or pathway involved. You're welcome to choose multiple codes if they clearly apply. Refer to the official definitions if you need assistance.<br><br>Press the reset button at the bottom to reset the codes selected.`
                    singleTaxonomyInstructions(instructions);

                    Object.entries(data).forEach((category) => {
                        const wrapper = document.createElement("div");
                        wrapper.className = "taxonomy-entry";

                        const button = document.createElement("button");
                        button.textContent = category[1];
                        button.classList.add("toggle-button");
                        button.id = "btn" + category[1].split(":")[0];
                        button.onclick = () => {
                            displayCategory(category[1], taxonomy);
                            toggleButtons(button.id, "leftContent");
                        }

                        wrapper.appendChild(button);
                        menu.appendChild(wrapper);
                    });
                })
                .catch(err => {
                    menu.innerHTML = `<p style="color:red;">Failed to load ${placeholder.toLowerCase()}.</p>`;
                    console.error(err);
                });
        }

        function displayCategory(category, taxonomy){
            let api = "";
            let single = false;
            let placeholder = "";

            if (taxonomy == "PPS"){
                api = "pathwaysubcodes"
                single = true;
                placeholder = "Pathway Subcodes"
            } else if (taxonomy == "APS"){
                api = "pathwaysubcodes"
                placeholder = "Pathway Subcodes"
            } else if (taxonomy == "MD"){
                api = "pathwaysubcodes"
                single = true;
                placeholder = "Pathway Subcodes"
            } else if (taxonomy == "CF"){
                api = "contributoryfactors"
                placeholder = "Contributory Factors"
            }

            const menu = document.getElementById("rightContent");
            menu.innerHTML = `Loading ${placeholder}`;

            fetch(`/api/${api}/${category}`)
                .then(res => res.json())
                .then(data => {
                    menu.innerHTML = '';
                    sortCodes(Object.keys(data)).forEach(code => {
                        const detailList = data[code];
                        const label = detailList;

                        const wrapper = document.createElement("div");
                        wrapper.className = "taxonomy-entry";

                        if (single){
                            const detailList = data[code];
                            const label = detailList;

                            const wrapper = document.createElement("div");
                            wrapper.className = "taxonomy-entry";

                            const button = document.createElement("button");
                            button.textContent = code
                            button.classList.add("toggle-button");
                            button.id = "btn" + code;
                            button.onclick = () => {
                                insertSingleCode(taxonomy == "MD" ? "MD" + code : code, taxonomy);
                                toggleButtons(button.id, "rightContent");
                                {% if not singleTaxonomy %}
                                    if (taxonomy == "PPS"){
                                        addRemoveMultiCode(code, "APS", false);
                                    }
                                {% endif %}
                            }

                            const buttonLabel = document.createElement("label");
                            buttonLabel.innerHTML = label;

                            wrapper.appendChild(button);
                            wrapper.appendChild(buttonLabel);
                            menu.appendChild(wrapper);

                            if (document.getElementById("mainTextBox").value.includes(taxonomy == "MD" ? "MD" + code : code) && taxonomy != "PPS"){
                                toggleButtons(button.id, "rightContent")
                            } else if (taxonomy == "PPS" && document.getElementById("mainTextBox").value.split(" / ")[2] == code){
                                toggleButtons(button.id, "rightContent")
                            }
                        } else{
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.value = label;
                            checkbox.id = `cb-${code}`;
                            checkbox.checked = document.getElementById("mainTextBox").value.split(" / ").splice(4).includes(code);

                            {% if not singleTaxonomy %}
                                checkbox.disabled = document.getElementById("mainTextBox").value.split("/")[2].trim() == code
                            {% endif %}

                            if ("{{ singleTaxonomy|default('') }}".trim() != ""){
                                checkbox.checked = document.getElementById("mainTextBox").value.includes(code);
                            }
                            checkbox.onchange = () => addRemoveMultiCode(code, taxonomy, checkbox.checked);

                            const checkboxLabel = document.createElement("label");
                            checkboxLabel.htmlFor = checkbox.id;
                            checkboxLabel.innerHTML = `${code}: ${label}`;

                            wrapper.appendChild(checkbox);
                            wrapper.appendChild(checkboxLabel);
                            menu.appendChild(wrapper);
                        }
                    });
                })
                .catch(err => {
                    menu.innerHTML = '<p style="color:red;">Failed to load pathway subcodes.</p>';
                    console.error(err);
                }
            );
        }

        function addRemoveMultiCode(code, taxonomy, addBool) {
            const tb = document.getElementById("mainTextBox");
            let tbList = tb.value.split(" / ");

            // Inform the parent window the taxonomies have been updated
            window.parent.postMessage({ action: "taxonomyUpdated" }, "*");

            let placeholder = [];
            if (taxonomy == "APS"){
                placeholder = "(Additional Pathway Subcodes)";
                {% if singleTaxonomy %}
                    placeholder = "(Pathway Subcodes)";
                {% endif %}
            } else if (taxonomy == "CF"){
                placeholder = "(Contributory Factors)";
            }
            
            if ("{{ singleTaxonomy|default('') }}".trim() != ""){
                if (addBool){
                    if (tb.value == placeholder){
                        tb.value = code;
                    } else {
                        tb.value = sortCodes(tbList.concat(code)).join(" / ");
                    } 
                } else {
                    const index = tbList.indexOf(code);
                    if(index != -1){
                        tbList.splice(index, 1);
                    }

                    if (tbList.length != 0){
                        tb.value = tbList.join(" / ");
                    } else {
                        tb.value = placeholder;
                    }
                }

                updateMenuButtonStatus();
                return;
            }

            let MDPoint = -1
            for (let i = 4; i < tbList.length; i++){
                if (tbList[i].includes("MD") || tbList[i].includes("(Method of Detection)")){
                    MDPoint = i;
                    break;
                }
            }

            let ClTax = tbList.slice(0, 2);
            let PPSTax = tbList.slice(2, 3);
            let APSTax = tbList.slice(3, MDPoint);
            let MDTax = tbList[MDPoint];
            let CFTax = tbList.slice(MDPoint + 1, tbList.length - 1);
            let modalityTax = tbList[tbList.length - 1];

            let taxonomyToEdit = [];
            if (taxonomy == "APS"){
                taxonomyToEdit = APSTax;
            } else if (taxonomy == "CF"){
                taxonomyToEdit = CFTax;
            }

            if(addBool){
                if (taxonomyToEdit[0] == placeholder){
                    taxonomyToEdit[0] = code;
                } else if(!taxonomyToEdit.includes(code)){
                    taxonomyToEdit = sortCodes(taxonomyToEdit.concat(code));
                }
            } else {
                const index = taxonomyToEdit.indexOf(code);
                if(index != -1){
                    taxonomyToEdit.splice(index, 1);
                }
                if (taxonomyToEdit.length === 0) {
                    taxonomyToEdit.push(placeholder);
                }
            }

            let fullTaxonomy = []
            if (taxonomy == "APS"){
                fullTaxonomy = ClTax.concat(PPSTax, sortCodes(taxonomyToEdit), MDTax, sortCodes(CFTax), modalityTax);
            } else if (taxonomy == "CF"){
                fullTaxonomy = ClTax.concat(PPSTax, sortCodes(APSTax), MDTax, sortCodes(taxonomyToEdit), modalityTax);
            }

            tb.value = fullTaxonomy.join(" / ")
            updateMenuButtonStatus();
        }

        function isNumeric(n) {
            return !isNaN(parseFloat(n)) && isFinite(n);
        }

        function toggleMenuButtons(activeBtnID) {
            const buttons = document.querySelectorAll(".button-row button");

            buttons.forEach(btn => {
                btn.classList.remove("selected-button");
            });

            const activeBtn = document.getElementById(activeBtnID);
            if (activeBtn) {
                activeBtn.classList.add("selected-button");
            }
        }

        function sortCodes(codes){
            if (codes.length == 0){
                return [];
            }

            const example = codes[0];

            let prefix = "";
            for (i = 0; i < example.length; i++){
                if(isNumeric(example[i])){
                    prefix = example.slice(0, i);
                    break;
                }
            }

            let splitCodes = [];

            for (j = 0; j < codes.length; j++){
                let index = -1;

                for (k = prefix.length; k < codes[j].length; k++){
                    if(!isNumeric(codes[j][k])){
                        index = k;
                        break;
                    }
                }

                splitCodes.push([prefix, codes[j].slice(prefix.length, index), codes[j].slice(index)]);
            }

            splitCodes.sort((a, b) => {
                const numA = parseInt(a[1], 10);
                const numB = parseInt(b[1], 10);
                if (numA !== numB) return numA - numB;
                if (a[2].length !== b[2].length) return a[2].length - b[2].length;
                return a[2].localeCompare(b[2]);
            });

            return splitCodes.map(parts => prefix + parts[1] + parts[2]);
        }

        function updateMenuButtonStatus() {
            const tbString = document.getElementById("mainTextBox").value;

            const sections = {
                Cl: ["(Classification)", "ClBtn"],
                PPS: ["(Primary Pathway Subcode)", "PPSBtn"],
                APS: ["(Additional Pathway Subcodes)", "APSBtn"],
                MD: ["(Method of Detection)", "MDBtn"],
                CF: ["(Contributory Factors)", "CFBtn"],
                Modality: ["(Modality)", "ModalityBtn"]
            };

            Object.entries(sections).forEach(([taxonomy, [placeholder, btnID]]) => {
                const btn = document.getElementById(btnID);
                // Only try to update the button if it actually exists
                if (!btn) return;

                if (!tbString.includes(placeholder)) {
                    btn.classList.add("menu-button-complete");
                } else {
                    btn.classList.remove("menu-button-complete");
                }
            });

            {% if not singleTaxonomy %}
                const InstructionsBtn = document.getElementById("InstructionsBtn");
                InstructionsBtn.classList.add("menu-button-complete");
            {% endif %}
        }

        function clearText() {
            let taxonomy = "{{ singleTaxonomy|default('') }}".toUpperCase();
            document.getElementById("rightContent").innerHTML = "";
            toggleButtons("", "leftContent");
            toggleButtons("", "taxonomyMenuSingle");
            
            let taxCl = sortCodes({{ ClTaxonomy|default([])|tojson }});
            let taxPPS = sortCodes({{ PPSTaxonomy|default([])|tojson }});
            let taxAPS = sortCodes({{ APSTaxonomy|default([])|tojson }});
            let taxMD = sortCodes({{ MDTaxonomy|default([])|tojson }});
            let taxCF = sortCodes({{ CFTaxonomy|default([])|tojson }});
            let taxModality = sortCodes({{ modalityTaxonomy|default([])|tojson }});
            
            if (taxonomy == "CL") {
                document.getElementById("mainTextBox").value =
                    (taxCl.length ? taxCl[0] : "(Classification)");
            } else if (taxonomy == "PPS") {
                document.getElementById("mainTextBox").value =
                    (taxPPS.length ? taxPPS[0] : "(Primary Pathway Subcode)");
            } else if (taxonomy == "APS") {
                document.getElementById("mainTextBox").value =
                    taxAPS.length
                    ? taxAPS.join(" / ")
                    : (taxonomy == "" ? "(Additional Pathway Subcodes)" : "(Pathway Subcodes)");
            } else if (taxonomy == "MD") {
                document.getElementById("mainTextBox").value =
                    (taxMD.length ? taxMD[0] : "(Method of Detection)");
            } else if (taxonomy == "CF") {
                document.getElementById("mainTextBox").value =
                    (taxCF.length ? taxCF.join(" / ") : "(Contributory Factors)");
            } else if (taxonomy == "MODALITY") {
                document.getElementById("mainTextBox").value =
                    (taxModality.length ? taxModality[0] : "(Modality)");
            }
            
            if (taxonomy == "") {
                let finalText = "TSRT9";
                finalText += " / " + (taxCl.length ? taxCl.join(" / ") : "(Classification)");
                finalText += " / " + (taxPPS.length ? taxPPS[0] : "(Primary Pathway Subcode)");
                finalText += " / " + (taxAPS.length ? taxAPS.join(" / ") : "(Additional Pathway Subcodes)");
                finalText += " / " + (taxMD.length ? taxMD.join(" / ") : "(Method of Detection)");
                finalText += " / " + (taxCF.length ? taxCF.join(" / ") : "(Contributory Factors)");
                finalText += " / " + (taxModality.length ? taxModality[0] : "(Modality)");
                document.getElementById("mainTextBox").value = finalText;
            }

            updateMenuButtonStatus();
        }

        window.addEventListener("message", function(event) {
            // Optionally, validate event.origin here.
            if (event.data && event.data.action === "getValue") {
                const value = document.getElementById("mainTextBox").value;
                window.parent.postMessage({ action: "sendValue", value: value }, "*");
            }
        });

        window.addEventListener("DOMContentLoaded", function() {
            // Directly call clearText to set the correct taxonomies
            clearText();
            toggleMenuButtons("");

            var singleTax = "{{ singleTaxonomy|default('') }}".toUpperCase();
            if (singleTax) {
                if (["CL", "MODALITY"].includes(singleTax)){
                    showSingleScreenOptions(singleTax.charAt(0).toUpperCase() + singleTax.slice(1).toLowerCase())
                } else if (["PPS", "APS", "MD", "CF"].includes(singleTax)){
                    showMultiScreenOptions(singleTax);
                }
            }
            else {
                showInstructions();
                const InstructionsBtn = document.getElementById("InstructionsBtn");
                InstructionsBtn.classList.remove("menu-button-complete");
            }
        });
    </script>
</body>
</html>
